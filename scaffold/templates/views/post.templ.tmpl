package views

import (
	"github.com/eringen/pubengine"
	"github.com/eringen/pubengine/markdown"
)

// Post renders the full blog post page.
templ Post(post pubengine.BlogPost, posts []pubengine.BlogPost, siteURL string) {
	<!DOCTYPE html>
	<html lang="en" class="bg-white dark:bg-gray-900">
		@DarkModeScript()
		@HeadWithMeta(pubengine.PageMeta{
			Title:       post.Title,
			Description: post.Summary,
			URL:         pubengine.BuildURL(siteURL, "blog", post.Slug),
			OGType:      "article",
		}, "{{.SiteName}}")
		<body class="min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
			@Nav("{{.SiteName}}")
			<main id="content" class="max-w-3xl mx-auto px-4 py-8">
				@postContent(post, posts)
			</main>
			@Footer("{{.SiteName}}")
			@JsonLD(pubengine.BlogPostingJsonLD(post, pubengine.SiteConfig{Name: "{{.SiteName}}", URL: siteURL}))
		</body>
	</html>
}

// PostPartial renders the post content for HTMX partial updates.
templ PostPartial(post pubengine.BlogPost, posts []pubengine.BlogPost, siteURL string) {
	<title>{ post.Title } | {{.SiteName}}</title>
	<main id="content" class="max-w-3xl mx-auto px-4 py-8">
		@postContent(post, posts)
	</main>
}

templ postContent(post pubengine.BlogPost, posts []pubengine.BlogPost) {
	<article>
		<header class="mb-8">
			<h1 class="text-3xl font-bold mb-2">{ post.Title }</h1>
			<time class="text-sm text-gray-500 dark:text-gray-400">{ post.Date }</time>
			if len(post.Tags) > 0 {
				<div class="mt-2 flex gap-2">
					for _, tag := range post.Tags {
						<a
							href={ templ.SafeURL("/?tag=" + pubengine.PathEscape(tag)) }
							class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"
						>
							{ tag }
						</a>
					}
				</div>
			}
		</header>
		<div class="prose dark:prose-invert max-w-none">
			@markdown.Markdown(post.Content)
		</div>
	</article>
	<!-- Related Posts -->
	if related := pubengine.FilterRelatedPosts(post, posts); len(related) > 0 {
		<aside class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-700">
			<h2 class="text-lg font-semibold mb-4">Related Posts</h2>
			<div class="space-y-4">
				for _, rp := range related {
					<a
						href={ templ.SafeURL(rp.Link + "/") }
						hx-get={ rp.Link + "/?partial=post" }
						hx-target="#content"
						hx-swap="outerHTML"
						hx-push-url={ rp.Link + "/" }
						class="block hover:text-blue-600 dark:hover:text-blue-400"
					>
						<h3 class="font-medium">{ rp.Title }</h3>
						<time class="text-sm text-gray-500 dark:text-gray-400">{ rp.Date }</time>
					</a>
				}
			</div>
		</aside>
	}
}
